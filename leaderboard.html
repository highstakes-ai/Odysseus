<script src="tasks.js"></script>
<script>
  const WORKER_URL = 'https://fitted.aihighstakes.workers.dev';

  // Leaderboard load
  async function loadLeaderboard() {
    const container = document.getElementById('leaderboard-body');
    try {
      const res = await fetch(`${WORKER_URL}/leaderboard`);
      if (!res.ok) throw new Error();
      const data = await res.json();
      if (data.length === 0) {
        container.innerHTML = '<div class="loading">No referrals yet – be the first!</div>';
        return;
      }
      container.innerHTML = data.map((user, index) => {
        const rank = index + 1;
        const crown = rank === 1 ? `<img src="https://thumbs.dreamstime.com/b/golden-crown-ranking-ribbons-vector-illustration-two-gold-japanese-text-meaning-no-sales-popularity-flat-graphic-style-413010595.jpg" alt="Crown" class="crown">` : '';
        return `
          <div class="lb-row">
            <div class="lb-rank-num">${crown || ''}${rank === 1 ? '' : rank}</div>
            <div class="lb-user-name">${user.email.split('@')[0]}***</div>
            <div class="lb-refs-num">${user.referrals}</div>
          </div>
        `;
      }).join('');
    } catch (err) {
      container.innerHTML = '<div class="loading">Leaderboard coming soon...<br><small>Backend deploying – refresh in a minute!</small></div>';
    }
  }
  loadLeaderboard();
  setInterval(loadLeaderboard, 60000);

  // Pre-fill referral code from URL
  const urlParams = new URLSearchParams(window.location.search);
  const urlRef = urlParams.get('ref');
  if (urlRef) {
    document.getElementById('ref-code').value = urlRef.toUpperCase();
  }

  // Main sign-up form
  const form = document.getElementById('signup-form');
  const messageDiv = document.getElementById('message');
  const submitBtn = document.getElementById('submit-btn');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    messageDiv.innerHTML = '';
    submitBtn.disabled = true;
    submitBtn.textContent = 'Joining...';
    const email = document.getElementById('email').value.trim();
    const manualRefCode = document.getElementById('ref-code').value.trim().toUpperCase();
    let ref = urlParams.get('ref') || '';
    if (manualRefCode) ref = manualRefCode;
    try {
      const formData = new FormData();
      formData.append('email', email);
      const endpoint = ref ? `${WORKER_URL}/signup?ref=${encodeURIComponent(ref)}` : `${WORKER_URL}/signup`;
      const response = await fetch(endpoint, { method: 'POST', body: formData });
      let result;
      try { result = await response.json(); } catch { result = { error: 'Invalid response' }; }
      if (response.ok && result.success) {
        let successMsg = result.message || 'Welcome! You’re on the waitlist.';
        if (result.code) successMsg += `<br>Your referral code: <strong>${result.code}</strong><br>Share: <strong>https://highstakes-ai.github.io/Odysseus/leaderboard?ref=${result.code}</strong>`;
        messageDiv.innerHTML = `<div class="message success">${successMsg}</div>`;
        form.reset();
        document.getElementById('ref-code').value = '';
        loadLeaderboard();
      } else {
        messageDiv.innerHTML = `<div class="message error">${result.error || 'Something went wrong'}</div>`;
      }
    } catch (err) {
      messageDiv.innerHTML = `<div class="message error">Network error – try again</div>`;
    }
    submitBtn.disabled = false;
    submitBtn.textContent = 'Join Now';
  });

  // Stats Login
  const statsEmailInput = document.getElementById('stats-email');
  const checkStatsBtn = document.getElementById('check-stats-btn');
  const statsMessage = document.getElementById('stats-message');
  const modal = document.getElementById('signup-modal');
  const closeModal = document.getElementById('close-modal');
  const modalEmail = document.getElementById('modal-email');
  const modalRefCode = document.getElementById('modal-ref-code');
  const modalForm = document.getElementById('modal-signup-form');
  const modalMessage = document.getElementById('modal-message');

  checkStatsBtn.addEventListener('click', async () => {
    const email = statsEmailInput.value.trim().toLowerCase();
    if (!email || !email.includes('@')) {
      statsMessage.innerHTML = '<small style="color:#c53030;">Enter a valid email</small>';
      return;
    }
    statsMessage.innerHTML = 'Checking...';

    try {
      const res = await fetch(`${WORKER_URL}/leaderboard`);
      const users = await res.json();
      const user = users.find(u => u.email.toLowerCase() === email);

      if (user) {
        currentUser = {
          email: user.email,
          referrals: user.referrals || 0,
          gemsEarned: user.gemsEarned || 0,
          confirmed: true,
          claimedMilestones: [] // We don't have this in leaderboard response yet — optional future
        };
        statsMessage.innerHTML = '<small style="color:#2e8b57;">Stats loaded!</small>';
        TasksModule.render();
      } else {
        modalEmail.value = email;
        modalRefCode.value = urlRef ? urlRef.toUpperCase() : '';
        modal.style.display = 'flex';
        statsMessage.innerHTML = '';
      }
    } catch {
      statsMessage.innerHTML = '<small style="color:#c53030;">Error checking email</small>';
    }
  });

  closeModal.addEventListener('click', () => modal.style.display = 'none');

  modalForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    modalMessage.innerHTML = 'Joining...';
    const email = modalEmail.value.trim();
    const ref = modalRefCode.value.trim().toUpperCase() || urlParams.get('ref') || '';
    try {
      const formData = new FormData();
      formData.append('email', email);
      const endpoint = ref ? `${WORKER_URL}/signup?ref=${encodeURIComponent(ref)}` : `${WORKER_URL}/signup`;
      const response = await fetch(endpoint, { method: 'POST', body: formData });
      const result = await response.json();
      if (response.ok && result.success) {
        modalMessage.innerHTML = '<div class="message success">Welcome! Check your email to confirm.</div>';
        setTimeout(() => modal.style.display = 'none', 2000);
        loadLeaderboard();
      } else {
        modalMessage.innerHTML = `<div class="message error">${result.error || 'Error'}</div>`;
      }
    } catch {
      modalMessage.innerHTML = '<div class="message error">Network error</div>';
    }
  });

  // Initial render
  TasksModule.render();
</script>
