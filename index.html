<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FITTED.AI - Top AI Picks</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            padding-bottom: 80px;
        }

        .header {
            background-color: #f0f0f0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 1px solid #ddd;
            position: relative;
        }

        .logo {
            font-size: 28px;
            font-weight: 900;
            letter-spacing: -1px;
            color: #2c3e50;
        }

        .menu-icon {
            font-size: 28px;
            cursor: pointer;
            position: absolute;
            right: 20px;
        }

        .page-title {
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            margin: 30px 0;
            color: #2c3e50;
        }

        .store-module {
            max-width: 400px;
            margin: 0 auto 40px;
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .user-budget {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .store-name {
            font-size: 18px;
            font-weight: 600;
        }

        .total-price {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
        }

        .products-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .product-card {
            background-color: #e8e8e8;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .product-card:hover {
            transform: translateX(2px);
        }

        .product-image {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
            border-radius: 8px;
            background-color: #fff;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-info {
            flex-grow: 1;
        }

        .product-name {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
        }

        .product-price {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .more-options {
            color: #999;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .budget-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .budget-btn {
            background-color: white;
            border: 2px solid #333;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: normal;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .budget-btn:hover {
            background-color: #f8f8f8;
        }

        .budget-btn.active {
            background-color: #3498db;
            border-color: #3498db;
            color: white;
        }

        .add-to-cart {
            width: 100%;
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .add-to-cart:hover {
            background-color: #1a252f;
        }

        .browse-btn {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 400px;
            margin: 0 auto;
            background-color: #3498db;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 0;
            font-size: 15px;
            font-weight: normal;
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .browse-btn:hover {
            background-color: #2980b9;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">FITTED.AI</div>
        <div class="menu-icon">â˜°</div>
    </div>

    <h1 class="page-title">Top Ai picks</h1>

    <div id="modules-container">
        <div class="loading">Loading your outfits...</div>
    </div>

    <button class="browse-btn" id="browse-all-btn">
        Browse All Products<br>
        <span style="font-size: 13px; opacity: 0.9;">Select Your Own</span>
    </button>

    <script>
        // Extract store name from URL
        function getStoreName(url) {
            try {
                const domain = new URL(url).hostname;
                // Remove www. and .co.nz or .com
                return domain.replace('www.', '').replace(/\.(co\.nz|com|co)$/, '');
            } catch {
                return url;
            }
        }

        // Calculate total price
        function calculateTotal(items) {
            return items.reduce((sum, item) => {
                const price = parseFloat(item.price) || 0;
                return sum + price;
            }, 0).toFixed(2);
        }

        // Render products
        function renderProducts(items) {
            return items.map(item => `
                <div class="product-card" onclick="window.open('${item.link}', '_blank')">
                    <div class="product-image">
                        ${item.image ? `<img src="${item.image}" alt="${item.title}">` : 'ðŸ‘•'}
                    </div>
                    <div class="product-info">
                        <div class="product-name">${item.title}</div>
                        <div class="product-price">$${item.price}</div>
                    </div>
                </div>
            `).join('');
        }

        // Create a store module
        function createStoreModule(storeUrl, storeData) {
            const storeName = getStoreName(storeUrl);
            const recommended = storeData.recommended || [];
            const underBudget = storeData.under_budget || [];
            const overBudget = storeData.over_budget || [];
            
            const total = calculateTotal(recommended);
            
            const moduleId = `module-${storeName.replace(/[^a-z0-9]/g, '-')}`;
            
            return `
                <div class="store-module" id="${moduleId}">
                    <div class="user-budget">
                        <div class="store-name">${storeName}</div>
                        <div class="total-price">$${total}</div>
                    </div>

                    <div class="products-grid">
                        ${renderProducts(recommended)}
                    </div>

                    <div class="more-options">More options from ${storeName}</div>

                    <div class="budget-buttons">
                        <button class="budget-btn" data-type="under" data-module="${moduleId}">
                            Under budget â¬‡
                        </button>
                        <button class="budget-btn" data-type="over" data-module="${moduleId}">
                            Over budget â¬†
                        </button>
                    </div>

                    <button class="add-to-cart" data-store="${storeName}">Add to cart</button>
                </div>
            `;
        }

        // Load and render data
        function loadOutfits() {
            const dataStr = sessionStorage.getItem('outfitData');
            
            if (!dataStr) {
                document.getElementById('modules-container').innerHTML = 
                    '<div class="no-data">No outfits found. Please go back to settings.</div>';
                return;
            }

            try {
                const data = JSON.parse(dataStr);
                const container = document.getElementById('modules-container');
                
                // Store data globally for button interactions
                window.outfitData = data;
                
                // Create modules for each store
                const modules = Object.entries(data)
                    .map(([storeUrl, storeData]) => createStoreModule(storeUrl, storeData))
                    .join('');
                
                container.innerHTML = modules;
                
                // Add event listeners for budget buttons
                document.querySelectorAll('.budget-btn').forEach(btn => {
                    btn.addEventListener('click', handleBudgetClick);
                });

                // Add event listeners for add to cart buttons
                document.querySelectorAll('.add-to-cart').forEach(btn => {
                    btn.addEventListener('click', handleAddToCart);
                });
                
            } catch (err) {
                console.error('Error loading outfits:', err);
                document.getElementById('modules-container').innerHTML = 
                    '<div class="no-data">Error loading outfits. Please try again.</div>';
            }
        }

        // Handle budget button clicks
        function handleBudgetClick(e) {
            const btn = e.currentTarget;
            const type = btn.dataset.type;
            const moduleId = btn.dataset.module;
            const module = document.getElementById(moduleId);
            
            // Get store data
            const storeName = module.querySelector('.store-name').textContent;
            const storeData = Object.values(window.outfitData).find(data => {
                const url = Object.keys(window.outfitData).find(key => 
                    getStoreName(key) === storeName
                );
                return url && window.outfitData[url] === data;
            });
            
            if (!storeData) return;
            
            // Get the appropriate items
            let items, otherType, otherLabel;
            if (type === 'under') {
                items = storeData.under_budget || [];
                otherType = 'recommended';
                otherLabel = 'Recommended âœ¨';
            } else {
                items = storeData.over_budget || [];
                otherType = 'recommended';
                otherLabel = 'Recommended âœ¨';
            }
            
            // Update products
            const productsGrid = module.querySelector('.products-grid');
            productsGrid.innerHTML = renderProducts(items);
            
            // Update total
            const total = calculateTotal(items);
            module.querySelector('.total-price').textContent = `$${total}`;
            
            // Update button states
            const buttons = module.querySelectorAll('.budget-btn');
            buttons.forEach(b => {
                if (b === btn) {
                    b.classList.add('active');
                    b.textContent = otherLabel;
                    b.dataset.type = otherType;
                } else {
                    b.classList.remove('active');
                }
            });
        }

        // Handle add to cart
        function handleAddToCart(e) {
            const storeName = e.currentTarget.dataset.store;
            alert(`Adding items from ${storeName} to cart!`);
            // TODO: Implement actual cart functionality
        }

        // Browse button
        document.getElementById('browse-all-btn').addEventListener('click', () => {
            alert('Browse all products coming soon!');
        });

        // Initialize
        loadOutfits();
    </script>
</body>
</html>
